"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[176],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var c=a.createContext({}),l=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=l(e.components);return a.createElement(c.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,c=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=l(n),h=o,m=p["".concat(c,".").concat(h)]||p[h]||d[h]||r;return n?a.createElement(m,i(i({ref:t},u),{},{components:n})):a.createElement(m,i({ref:t},u))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=p;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var l=2;l<r;l++)i[l]=n[l];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},5996:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>d,frontMatter:()=>r,metadata:()=>s,toc:()=>l});var a=n(7462),o=(n(7294),n(3905));const r={sidebar_position:5},i="Caching/Memoization",s={unversionedId:"stopes/cache",id:"stopes/cache",title:"Caching/Memoization",description:"An important part of the launcher is its caching system. When you call the",source:"@site/docs/stopes/cache.md",sourceDirName:"stopes",slug:"/stopes/cache",permalink:"/stopes/docs/stopes/cache",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/stopes/cache.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5},sidebar:"quickstartSidebar",previous:{title:"Configuration",permalink:"/stopes/docs/stopes/configuration"},next:{title:"Advanced",permalink:"/stopes/docs/category/advanced"}},c={},l=[],u={toc:l};function d(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"cachingmemoization"},"Caching/Memoization"),(0,o.kt)("p",null,"An important part of the launcher is its caching system. When you call the\nschedule method with a configured module, the launcher will check if this\nconfiguration was already run in the past and reuse the results when possible.\nThe cache is indexed on the configuration of the module, so if you change\nanything in the configuration input, the module will be executed from scratch\nand the new result will be cached with a different key. It's also important to\nremember that all inputs to the module that could change its results (and thus\nthe caching) should be specified in the config input. Please note there is one\nexception to this mechanism: the ",(0,o.kt)("inlineCode",{parentName:"p"},"timeout_min")," key will be ignored for caching\nso changing it won't invalidate the cache."),(0,o.kt)("p",null,"If you change the code of your module to a point that would change its output,\nyou can implement the ",(0,o.kt)("inlineCode",{parentName:"p"},"version() "),"method to return a new value so that the cache\nknows that it needs to recompute from scratch even from known configs."),(0,o.kt)("p",null,"You can also implement the",(0,o.kt)("inlineCode",{parentName:"p"},"validate()"),"method to check the outputs from your\nmodule and from the cache if you want to actively invalidate the cache. For\nexample, if it\u2019s known how many lines are to be embedded into a particular\ndimension (say 1024), you can validate that the output file size is e.g.\n",(0,o.kt)("inlineCode",{parentName:"p"},"num_lines * 1024 * float32.")),(0,o.kt)("p",null,"Here is an example of rerunning the global mining pipeline that was interrupted\nin the middle. The caching layer recovers what was already executed\nsuccessfully. This was started with the same command that would require a full\nrun:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"python yourpipeline.py src_lang=bn tgt_lang=hi +data=ccg\n")),(0,o.kt)("p",null,"Here are the logs:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"[global_mining][INFO] - output: .../global_mining/outputs/2021-11-02/08-56-40\n[global_mining][INFO] - working dir: .../global_mining/outputs/2021-11-02/08-56-40\n[mining_utils][WARNING] - No mapping for lang bn\n[embed_text][INFO] - Number of shards: 55\n[embed_text][INFO] - Embed bn (hi), 55 files\n[stopes_launcher][INFO] - for encode.bn.55 found 55 already cached array results,0 left to compute out of 55\n[train_faiss_index][INFO] - lang=bn, sents=135573728, required=40000000, index type=OPQ64,IVF65536,PQ64\n[stopes_launcher][INFO] - index-train.bn.iteration_2 done from cache\n[stopes_launcher][INFO] - for populate_index.OPQ64,IVF65536,PQ64.bn found 44 already cached array results,11 left to compute out of 55\n[stopes_launcher][INFO] - submitted job array for populate_index.OPQ64,IVF65536,PQ64.bn: ['48535900_0', '48535900_1', '48535900_2', '48535900_3', '48535900_4', '48535900_5', '48535900_6', '48535900_7', '48535900_8', '48535900_9', '48535900_10']\n[mining_utils][WARNING] - No mapping for lang hi\n[embed_text][INFO] - Number of shards: 55\n[embed_text][INFO] - Embed hi (hi), 55 files\n[stopes_launcher][INFO] - for encode.hi.55 found 55 already cached array results,0 left to compute out of 55\n[train_faiss_index][INFO] - lang=hi, sents=162844151, required=40000000, index type=OPQ64,IVF65536,PQ64\n")),(0,o.kt)("p",null,"We can see that the launcher has found out that it doesn't need to run the\nencode and train index steps for the ",(0,o.kt)("inlineCode",{parentName:"p"},"bn")," lang (src language) and can skip\nstraight to populating the index with embeddings, but it also already processed\n44 shards for that step, so will only re-schedule jobs for 11 shards. In\nparallel, it is also processing the tgt language (",(0,o.kt)("inlineCode",{parentName:"p"},"hi"),") and found that it still\nneeds to run the index training step as it also recoverred all the encoded\nshards."),(0,o.kt)("p",null,"All this was done automatically. The person launching the pipeline doesn't have\nto micromanage what has already succeeded and what needs to be started when."),(0,o.kt)("p",null,"Each module can specify the ",(0,o.kt)("inlineCode",{parentName:"p"},"get_config_for_cache")," function in order to\ncustomize the keys that should be ignored or taken into account for the cache."))}d.isMDXComponent=!0}}]);